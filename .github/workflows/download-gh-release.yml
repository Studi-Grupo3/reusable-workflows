name: Reusable - Download artifacts from GitHub Release (simple)

on:
  workflow_call:
    inputs:
      target_owner_repo:
        required: true
        type: string
        description: 'Owner/repo do release (ex: Studi-Grupo3/artifacts)'
      tag:
        required: false
        type: string
        default: 'latest'
        description: 'Tag ou "latest"'
      patterns:
        required: true
        type: string
        description: 'Padrões separados por vírgula, ex: app-api.jar,api-consumer.jar,build.tar.gz'
      dest_dir:
        required: false
        type: string
        default: 'builds'
        description: 'Diretório destino local'

    secrets:
      RELEASE_READ_PAT:
        required: false

permissions:
  contents: read

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      - name: Preparar destino
        run: |
          set -euo pipefail
          DEST="${{ inputs.dest_dir }}"
          mkdir -p "$DEST"
          echo "Destino: $DEST"

      - name: Escolher token (GITHUB_TOKEN se destino == repo atual, senão RELEASE_READ_PAT)
        id: choose_token
        run: |
          set -euo pipefail
          TARGET="${{ inputs.target_owner_repo }}"
          CURRENT="${{ github.repository }}"
          echo "TARGET=$TARGET; CURRENT=$CURRENT"
          if [ "$TARGET" = "$CURRENT" ]; then
            echo "using_github_token=true" >> $GITHUB_OUTPUT
            echo "token_value=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
          else
            if [ -z "${{ secrets.RELEASE_READ_PAT }}" ]; then
              echo "using_github_token=false" >> $GITHUB_OUTPUT
              echo "token_value=" >> $GITHUB_OUTPUT
              echo "ERROR_NO_READ_PAT=1" >> $GITHUB_OUTPUT
            else
              echo "using_github_token=false" >> $GITHUB_OUTPUT
              echo "token_value=${{ secrets.RELEASE_READ_PAT }}" >> $GITHUB_OUTPUT
              echo "ERROR_NO_READ_PAT=0" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Validar token
        run: |
          set -euo pipefail
          if [ "${{ steps.choose_token.outputs.ERROR_NO_READ_PAT || '0' }}" = "1" ]; then
            echo "ERRO: download cross-repo requer RELEASE_READ_PAT no caller." >&2
            exit 1
          fi

      - name: Baixar patterns
        run: |
          set -euo pipefail
          TAG="${{ inputs.tag }}"
          TARGET="${{ inputs.target_owner_repo }}"
          DEST="${{ inputs.dest_dir }}"
          TOKEN="${{ steps.choose_token.outputs.token_value }}"
          export GH_TOKEN="$TOKEN"

          IFS=',' read -r -a PATS <<< "${{ inputs.patterns }}"
          for p in "${PATS[@]}"; do
            pat="$(echo "$p" | xargs)"
            if [ -z "$pat" ]; then continue; fi
            echo "Tentando baixar '$pat' de $TARGET@$TAG para $DEST"
            if gh release download "$TAG" -R "$TARGET" -p "$pat" -D "$DEST" 2>/dev/null; then
              echo "OK: $pat"
            else
              echo "WARN: $pat não encontrado em $TARGET@$TAG"
            fi
          done

      - name: Listar conteudo destino
        run: ls -la "${{ inputs.dest_dir }}" || true
