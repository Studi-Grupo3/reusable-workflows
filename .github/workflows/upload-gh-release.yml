name: Reusable - Upload single artifact to GitHub Release (minimal)

on:
  workflow_call:
    inputs:
      artifact_name:
        required: true
        type: string
        description: 'Nome do artifact (usado em actions/upload-artifact name), ex: app-build ou backend-app.jar'
      target_owner_repo:
        required: true
        type: string
        description: 'Owner/repo destino, ex: Studi-Grupo3/artifacts'
      tag:
        required: false
        type: string
        default: ''
        description: 'Tag do release (ex: v1.2.3). Se vazio, usa v{run_number}'
    outputs:
      release_tag:
        description: 'Tag utilizada no release'
        value: ${{ jobs.upload.outputs.release_tag }}
    secrets:
      RELEASE_PAT:
        required: true

permissions:
  contents: write

jobs:
  upload:
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.resolve_tag.outputs.release_tag }}

    steps:
      - name: Install gh CLI if missing
        run: |
          set -euo pipefail
          if ! command -v gh >/dev/null; then
            sudo apt-get update
            sudo apt-get install -y gh
          fi

      - name: Resolve tag
        id: resolve_tag
        run: |
          set -euo pipefail
          if [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="v${GITHUB_RUN_NUMBER}"
          fi
          echo "release_tag=$TAG" >> $GITHUB_OUTPUT

      - name: Download artifact (must have been uploaded earlier)
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: artifacts/

      - name: Select first file inside downloaded artifact
        id: select_file
        run: |
          set -euo pipefail
          FILE=$(find artifacts -type f -print -quit || true)
          if [ -z "$FILE" ]; then
            echo "No file found inside downloaded artifact 'artifacts/'" >&2
            exit 2
          fi
          echo "artifact_selected=$FILE" >> $GITHUB_OUTPUT

      - name: Diagnóstico do token GH (temporário, remove depois)
        env:
          # se estiver usando secret RELEASE_PAT passe-o para GH_TOKEN
          GH_TOKEN: ${{ secrets.RELEASE_PAT || '' }}
          OWNER: "Studi-Grupo3"
          REPO: "artifacts"
        run: |
          set -euo pipefail
      
          echo "==== VARS PRESENÇA (valores são mascarados por segurança) ===="
          if [ -n "${GITHUB_TOKEN:-}" ]; then echo "GITHUB_TOKEN: defined"; else echo "GITHUB_TOKEN: NOT defined"; fi
          if [ -n "${GH_TOKEN:-}" ]; then echo "GH_TOKEN: defined (length=${#GH_TOKEN})"; else echo "GH_TOKEN: NOT defined"; fi
          echo ""
      
          echo "==== gh auth status ===="
          # mostra qual conta está autenticada (não mostra token em claro)
          gh auth status || true
          echo ""
      
          echo "==== Quem é o token (usuario) via API /user ===="
          # esta chamada retorna o usuário associado ao token (e falha se token inválido)
          gh api /user -H "Accept: application/vnd.github+json" || { echo "Falha ao obter /user (token inválido ou sem permissão)"; exit 0; }
          echo ""
      
          echo "==== Permissões do token para o repo alvo (/repos/OWNER/REPO) ===="
          gh api /repos/$OWNER/$REPO -H "Accept: application/vnd.github+json" --jq '.permissions' || echo "Não foi possível obter permissoes (403/401)"
          echo ""

      - name: Create (if needed) and upload to release
        run: |
          set -euo pipefail
          TAG="${{ steps.resolve_tag.outputs.release_tag }}"
          TARGET="${{ inputs.target_owner_repo }}"
          ART="${{ steps.select_file.outputs.artifact_selected }}"
          export GH_TOKEN="${{ secrets.RELEASE_PAT }}"

          if gh release view "$TAG" -R "$TARGET" >/dev/null 2>&1; then
            echo "Release $TAG already exists in $TARGET"
          else
            gh release create "$TAG" --repo "$TARGET" --title "Release $TAG" --notes "Automated release"
          fi

          gh release upload "$TAG" "$ART" --repo "$TARGET" --clobber

      - name: Expose release_tag
        run: |
          echo "release_tag=${{ steps.resolve_tag.outputs.release_tag }}" >> $GITHUB_OUTPUT